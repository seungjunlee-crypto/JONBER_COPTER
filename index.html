<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì¡´ë²„ì½¥í„° : V6.8 RESPONSIVE POPUP</title>
    <style>
        /* === 1. ê¸°ë³¸ ì„¤ì • === */
        @import url('https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Press+Start+2P&family=Noto+Sans+KR:wght@400;700&display=swap');

        body {
            margin: 0; padding: 0;
            width: 100vw; height: 100vh;
            background: #000; display: flex; justify-content: center; align-items: center;
            overflow: hidden; user-select: none;
            font-family: 'Press Start 2P', cursive;
            touch-action: none;
        }

        /* ìŠ¤í¬ë¡¤ë°” ì»¤ìŠ¤í…€ (íŒì—… ë‚´ë¶€ìš©) */
        ::-webkit-scrollbar { width: 1vh; }
        ::-webkit-scrollbar-track { background: #222; }
        ::-webkit-scrollbar-thumb { background: #555; border-radius: 0.5vh; }
        ::-webkit-scrollbar-thumb:hover { background: #777; }

        /* === 2. ë©”ì¸ ì»¨í…Œì´ë„ˆ === */
        .main-container {
            position: relative;
            aspect-ratio: 16 / 9;
            width: 100%; height: 100%;
            max-width: 177.78vh; max-height: 56.25vw;
            background: #111; overflow: hidden;
            box-shadow: 0 0 5vh rgba(0,0,0,0.8);
            font-size: 2vh; 
        }

        .game-frame {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, 
                #4a0000 0%, #200505 20%, #000000 40%, #000000 70%, #1a0b2e 90%, #2c003e 100%
            );
            background-size: 100% 400%; background-position: center bottom;
            transition: background-position 0.1s linear;
        }

        /* === 3. ë°°ê²½ ì˜¤ë¸Œì íŠ¸ === */
        .star-field { position: absolute; width: 100%; height: 100%; pointer-events: none; opacity: 0; transition: opacity 2s; }
        .stars-1 { width: 0.2vh; height: 0.2vh; box-shadow: 10vw 10vh #FFF, 30vw 40vh #FFF, 50vw 80vh #FFF; animation: fly-stars 20s linear infinite; }
        .stars-2 { width: 0.3vh; height: 0.3vh; box-shadow: 20vw 50vh #aaa, 60vw 10vh #aaa; animation: fly-stars 10s linear infinite; }
        .stars-3 { width: 0.4vh; height: 0.4vh; box-shadow: 40vw 30vh #888, 10vw 90vh #888; animation: fly-stars 5s linear infinite; }
        @keyframes fly-stars { from { transform: translateY(-100vh); } to { transform: translateY(100vh); } }
        .mars-fog { position: absolute; top: 0; left: 0; width: 100%; height: 60%; background: linear-gradient(to bottom, rgba(255, 50, 0, 0.3), transparent); opacity: 0; transition: opacity 3s; pointer-events: none; z-index: 5; }

        /* === 4. í—¬ê¸° === */
        :root { --heli-color: #e74c3c; --heli-shadow: #c0392b; }
        .skin-military { --heli-color: #556B2F; --heli-shadow: #3e4f20; }
        .skin-marine { --heli-color: #00BFFF; --heli-shadow: #0088cc; }
        .skin-gold { --heli-color: #FFD700; --heli-shadow: #DAA520; filter: drop-shadow(0 0 0.5vh gold); }

        .heli-wrapper { 
            position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);
            z-index: 20; width: 10vh; height: 5vh; 
        }
        .pixel-heli {
            width: 100%; height: 100%; background: var(--heli-color);
            border-radius: 0.5vh 1vh 1vh 0.5vh;
            box-shadow: 1.2vh 0 0 var(--heli-shadow), -1.5vh 0.8vh 0 #444, 2.5vh 0.8vh 0 #8ecae6; 
            position: relative; transition: background 0.3s;
        }
        .pixel-heli::before { content: ''; position: absolute; top: -1.5vh; left: 10%; width: 80%; height: 0.8vh; background: #eee; border-radius: 0.2vh; animation: rotor linear infinite; animation-duration: calc(0.1s / var(--speed-factor, 1)); }
        .pixel-heli::after { content: ''; position: absolute; bottom: -1.2vh; left: 10%; width: 70%; height: 0.8vh; border-bottom: 0.6vh solid #444; border-left: 0.6vh solid transparent; border-right: 0.6vh solid transparent; }
        @keyframes rotor { 0% { transform: scaleX(1); opacity:1; } 50% { transform: scaleX(0.2); opacity:0.6; } 100% { transform: scaleX(1); opacity:1; } }

        /* === 5. HUD UI === */
        .news-ticker-wrap { position: absolute; top: 0; left: 0; width: 100%; height: 6vh; background: rgba(0, 0, 0, 0.8); z-index: 90; overflow: hidden; white-space: nowrap; border-bottom: 0.2vh solid #444; display: flex; align-items: center; }
        .news-ticker-content { display: inline-block; padding-left: 100%; animation: ticker 20s linear infinite; color: #00ff00; font-family: 'Noto Sans KR'; font-size: 2.2vh; }
        @keyframes ticker { 0% { transform: translate3d(0, 0, 0); } 100% { transform: translate3d(-100%, 0, 0); } }

        /* ë„ì›€ë§ ë²„íŠ¼ */
        .help-btn { position: absolute; top: 1vh; right: 2vh; z-index: 150; background: #333; color: #fff; border: 0.2vh solid #fff; border-radius: 50%; width: 4vh; height: 4vh; font-size: 2.5vh; cursor: pointer; display: flex; justify-content: center; align-items: center; font-weight: bold; }

        .history-bar { position: absolute; top: 8vh; left: 2vh; display: flex; gap: 0.8vh; z-index: 90; }
        .history-dot { width: 2.5vh; height: 2.5vh; border-radius: 50%; border: 0.2vh solid rgba(255,255,255,0.3); }
        .h-blue { background: #3498db; } .h-green { background: #2ecc71; } .h-red { background: #e74c3c; } .h-gold { background: #f1c40f; box-shadow: 0 0 0.5vh #f1c40f; }

        .hud-profile {
            position: absolute; top: 14vh; left: 2vh; z-index: 100;
            background: rgba(0, 0, 0, 0.6); padding: 1.5vh 2.5vh; border-radius: 1vh; border: 0.2vh solid rgba(255,255,255,0.3);
            display: flex; flex-direction: column; align-items: flex-start;
        }
        .my-rank-badge { font-size: 1.8vh; padding: 0.3vh 0.8vh; border-radius: 0.5vh; margin-bottom: 0.5vh; color: #000; font-weight: bold; }
        .my-money { color: #4caf50; font-weight: bold; font-size: 2.2vh; text-shadow: 0.1vh 0.1vh 0 #000; }

        .hud-score { position: absolute; top: 8vh; right: 2vh; z-index: 100; text-align: right; }
        #score-box { font-family: 'Black Ops One'; font-size: 5vh; color: #ffd700; text-shadow: 0.3vh 0.3vh 0 #000; }
        .score-panic { color: #ff3333 !important; animation: shakeScore 0.1s infinite; }
        @keyframes shakeScore { 0% { transform: translate(0, 0); } 50% { transform: translate(0.5vh, -0.5vh); } 100% { transform: translate(0, 0); } }

        #timer-box { font-size: 2.5vh; color: #fff; text-shadow: 0.1vh 0.1vh 0 #000; margin-top: 0.5vh; }

        .hud-leaderboard {
            position: absolute; top: 22vh; right: 2vh; width: 25vh; max-height: 50vh;
            overflow-y: auto; pointer-events: none; z-index: 90; font-family: 'Noto Sans KR'; font-size: 1.5vh;
        }
        .lb-row { display: flex; justify-content: space-between; margin-bottom: 0.5vh; padding: 0.5vh 1vh; background: rgba(0,0,0,0.4); border-radius: 0.5vh; color: #fff; }
        .lb-me { color: #ffd700; font-weight: bold; border: 0.1vh solid rgba(255,215,0,0.5); }
        .bonus-tag { font-size: 1.2vh; padding: 0.2vh 0.5vh; border-radius: 0.3vh; margin-left: 0.5vh; font-weight: bold; color:#000; }
        .bonus-1 { background: #ffd700; } .bonus-2 { background: #c0c0c0; } .bonus-3 { background: #cd7f32; }

        .hud-warning { 
            position: absolute; top: 25%; left: 50%; transform: translateX(-50%); 
            background: rgba(255, 0, 0, 0.2); border: 0.3vh solid #ff3333; color: #ff3333; 
            padding: 1.5vh 3vh; border-radius: 1vh; font-weight: bold; font-size: 2.5vh; 
            display: none; z-index: 200; animation: blink 0.15s infinite alternate; font-family: 'Noto Sans KR'; 
        }
        @keyframes blink { from { opacity: 1; } to { opacity: 0.3; } }

        .chat-container { 
            position: absolute; bottom: 5vh; left: 2vh; 
            width: 40vh; height: 20vh; overflow: hidden; 
            pointer-events: none; display: flex; flex-direction: column-reverse; z-index: 90; 
        }
        .chat-msg { background: rgba(0, 0, 0, 0.6); color: #fff; padding: 0.5vh 1vh; margin-top: 0.5vh; border-radius: 0.5vh; font-family: 'Noto Sans KR'; font-size: 1.5vh; animation: fadeChat 5s forwards; }
        .chat-name { font-weight: bold; color: #ffd700; margin-right: 0.5vh; }
        @keyframes fadeChat { 0% { opacity:0; transform: translateY(1vh); } 10% { opacity:1; transform: translateY(0); } 90% { opacity:1; } 100% { opacity:0; } }

        .status-msg { position: absolute; bottom: 5vh; width: 100%; text-align: center; font-size: 2.2vh; color: #ccc; text-shadow: 0.1vh 0.1vh 0 #000; font-family: 'Noto Sans KR'; z-index: 100; pointer-events: none; }

        /* === 6. [ì•ˆ 1] ë°˜ì‘í˜• íŒì—… (Responsive Container) === */
        .center-msg { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            
            /* í•µì‹¬: í™”ë©´ í¬ê¸°ì— ë”°ë¥¸ ìœ ë™ì  ì‚¬ì´ì¦ˆ */
            width: 60%; 
            max-width: 600px;
            max-height: 80%; /* í™”ë©´ ë†’ì´ì˜ 80%ê¹Œì§€ë§Œ ì°¨ì§€ */
            overflow-y: auto; /* ë‚´ìš© ë„˜ì¹˜ë©´ ìŠ¤í¬ë¡¤ */
            
            text-align: center; pointer-events: auto; background: rgba(0,0,0,0.95); 
            padding: 3vh; border-radius: 2vh; border: 0.3vh solid #fff; 
            z-index: 200; box-shadow: 0 0 5vh rgba(0,0,0,0.8); 
            display: flex; flex-direction: column; gap: 2vh;
        }
        .center-msg h2 { color: white; margin: 0; font-size: 3.5vh; }
        .sub-title { font-size: 1.8vh; color: #aaa; font-family:'Noto Sans KR'; margin-bottom: 1vh;}
        
        .menu-row { display: flex; justify-content: space-between; align-items: center; gap: 1vh; width: 100%; }
        #nickname-input { flex: 1; padding: 1.5vh; background: #333; border: 0.3vh solid #555; color: #fff; text-align: center; border-radius: 0.8vh; font-size: 2vh; }
        
        .bet-container { display: flex; gap: 1vh; width: 100%; margin: 1vh 0; flex-wrap: wrap; }
        .bet-btn { 
            flex: 1; min-width: 8vh; padding: 1.5vh 0; font-family: 'Noto Sans KR'; font-weight: bold; font-size: 1.8vh; 
            cursor: pointer; border: 0.2vh solid #555; background: #222; color: #aaa; border-radius: 1vh; transition: 0.2s; 
        }
        .bet-btn.active { border-color: #ffd700; color: #000; background: #ffd700; box-shadow: 0 0 2vh rgba(255, 215, 0, 0.5); }
        
        .action-row { display: flex; gap: 1vh; width: 100%; flex-wrap: wrap;}
        #start-btn { flex: 2; min-width: 15vh; background: #4CAF50; color: white; border: none; padding: 2vh; font-weight:bold; font-size: 2.5vh; border-radius: 1vh; cursor: pointer; }
        .small-btn { flex: 1; min-width: 10vh; background: #555; color: white; border: none; padding: 2vh; border-radius: 1vh; cursor: pointer; font-size: 1.8vh; font-family:'Noto Sans KR';}
        #shop-btn { background: #E91E63; }

        /* ìƒì  ë° íŠœí† ë¦¬ì–¼ íŒì—… (ì „ì²´í™”ë©´ ì˜¤ë²„ë ˆì´ + ë°˜ì‘í˜• ë°•ìŠ¤) */
        .popup-modal { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.95); z-index: 300; 
            display: none; flex-direction: column; align-items: center; justify-content: center; 
            padding: 5%; box-sizing: border-box; /* íŒ¨ë”© í¬í•¨ í¬ê¸° ê³„ì‚° */
        }
        
        /* íŒì—… ë‚´ë¶€ ì»¨í…ì¸  ë°•ìŠ¤ */
        .popup-inner {
            width: 80%; max-width: 800px;
            max-height: 90%; /* í™”ë©´ ê½‰ ì°¨ì§€ ì•Šê²Œ */
            overflow-y: auto; /* ìŠ¤í¬ë¡¤ */
            background: #222; border: 0.3vh solid #555; border-radius: 2vh;
            padding: 3vh; box-sizing: border-box; text-align: center;
        }

        .popup-title { font-size: 3vh; color: #ffd700; margin-bottom: 3vh; font-family: 'Press Start 2P'; }
        
        .shop-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(10vh, 1fr)); gap: 2vh; width: 100%; } 
        .skin-card { background: #333; border: 0.3vh solid #555; padding: 1.5vh; border-radius: 1vh; text-align: center; cursor: pointer; }
        .skin-preview { width: 6vh; height: 3vh; margin: 1vh auto; display: block; }
        
        /* íŠœí† ë¦¬ì–¼ ìŠ¤íƒ€ì¼ */
        .tab-header { display: flex; background: #333; margin-bottom: 2vh; }
        .tab-btn { flex: 1; padding: 1.5vh; border: none; background: transparent; color: #aaa; font-family: 'Noto Sans KR'; font-size: 2vh; cursor: pointer; border-bottom: 0.3vh solid transparent; }
        .tab-btn.active { color: #ffd700; border-bottom: 0.3vh solid #ffd700; background: #2a2a2a; }
        .tab-body { text-align: left; font-family: 'Noto Sans KR'; font-size: 1.8vh; color: #ddd; line-height: 1.6; }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }
        .guide-icon { font-size: 3vh; margin-right: 1vh; vertical-align: middle; }
        .warn-text { color: #ff5555; font-weight: bold; }

        .btn-close { margin-top: 3vh; background: #555; color: white; border: none; padding: 1.5vh 3vh; cursor: pointer; font-size: 2vh; border-radius: 0.5vh;}

        /* === 7. ì´í™íŠ¸ === */
        .fever-overlay { position: absolute; top:0; left:0; width:100%; height:100%; box-shadow: inset 0 0 10vh 5vh rgba(255, 215, 0, 0.5); pointer-events: none; display: none; z-index: 90; animation: pulseGold 1s infinite; }
        .danger-overlay { position: absolute; top:0; left:0; width:100%; height:100%; box-shadow: inset 0 0 15vh 10vh rgba(255, 0, 0, 0.6); pointer-events: none; display: none; z-index: 90; animation: pulseRed 1s infinite; }
        @keyframes pulseGold { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
        @keyframes pulseRed { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
        
        .smoke { position: absolute; width: 3vh; height: 3vh; background: #ddd; border-radius: 50%; opacity: 0.8; animation: smokeOut 0.8s forwards; }
        @keyframes smokeOut { 
            from { left: 42%; top: 50%; transform: scale(1); } 
            to { left: 32%; top: 45%; transform: scale(3); opacity: 0; } 
        }
        .spark { position: absolute; width: 1vh; height: 1vh; background: #ffcc00; border-radius: 50%; box-shadow: 0 0 1vh #ff5500; animation: sparkOut 0.5s forwards ease-out; }
        @keyframes sparkOut { from { left: 50%; top: 50%; } to { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; } }
        
        .bot { position: absolute; width: 1.5vh; height: 3vh; background: #fff; box-shadow: 0 -1vh 0 #ffcc80; z-index: 25; animation: botDrop 3s forwards; }
        .parachute { position: absolute; top: -3vh; left: -2vh; width: 5.5vh; height: 3vh; background: #eee; border-radius: 5vh 5vh 0 0; animation: openChute 3s 0.3s forwards; border-top: 0.3vh solid #ccc; }
        @keyframes botDrop { 0% { opacity: 1; left: 50%; top: 50%; margin-left: -0.75vh; } 100% { left: 15%; top: 120%; opacity: 1; } }
        @keyframes openChute { 20% { transform: scale(1); } 100% { transform: scale(1); } }
        
        .player-chute .bot { background: #ffd700; box-shadow: 0 -1vh 0 #fff; }
        .player-chute .parachute { background: #ffd700; border-top: 0.3vh solid #ffcc00; }

        .crashed-anim { animation: crashDown 2s forwards !important; }
        @keyframes crashDown { 0% { transform: rotate(0deg); } 100% { transform: rotate(720deg); top: 120%; } }
    </style>
</head>
<body>

    <div class="main-container">
        <div class="game-frame" id="game-frame">
            <div class="news-ticker-wrap" id="news-ticker">
                <div class="news-ticker-content" id="news-content"></div>
            </div>
            <button class="help-btn" onclick="openTutorial()">?</button>

            <div class="star-field stars-1" id="stars1"></div>
            <div class="star-field stars-2" id="stars2"></div>
            <div class="star-field stars-3" id="stars3"></div>
            <div class="mars-fog" id="marsFog"></div>
            <div class="danger-overlay" id="danger-effect"></div>
            <div class="fever-overlay" id="fever-filter"></div>
            <div id="dynamic-layer"></div>
            
            <div class="hud-warning" id="warning-box">WARNING<br>ì—”ì§„ ê³¼ì—´</div>

            <div class="heli-wrapper" id="heli">
                <div class="pixel-heli" id="heli-body"></div>
            </div>

            <div class="history-bar" id="history-box"></div>

            <div class="hud-profile">
                <span class="my-rank-badge" id="my-rank-badge">ğŸ£ ì½”ë¦°ì´</span>
                <span class="my-money" id="my-money-display">5,000 G</span>
            </div>
            
            <div class="hud-score">
                <div id="score-box">0 G</div>
                <div id="timer-box">00.00s</div>
            </div>

            <div class="hud-leaderboard" id="lb-content"></div>
            <div class="chat-container" id="chat-box"></div>
            <div class="status-msg" id="status-msg">í™”ë©´ì„ í„°ì¹˜í•˜ì—¬ ë¹„í–‰ ì‹œì‘</div>

            <div class="center-msg" id="center-ui">
                <div>
                    <h2>JONBER COPTER</h2>
                    <div class="sub-title">To the Mars : ìƒì¡´ ë°°í‹€</div>
                </div>
                
                <div class="menu-row">
                    <input type="text" id="nickname-input" placeholder="ë‹‰ë„¤ì„ (ìµœëŒ€ 8ì)" maxlength="8">
                </div>

                <div style="font-size: 1.5vh; color: #aaa; text-align: left; width:100%;">ë°°íŒ… ê¸ˆì•¡ ì„ íƒ:</div>
                <div class="bet-container">
                    <button class="bet-btn active" onclick="setBet(1000, 1, this)">1ì²œì›<br>(x1)</button>
                    <button class="bet-btn" onclick="setBet(10000, 2, this)">1ë§Œì›<br>(x2)</button>
                    <button class="bet-btn" onclick="setBet(30000, 5, this)">3ë§Œì›<br>(x5)</button>
                </div>
                
                <div class="action-row">
                    <button id="start-btn">GAME START</button>
                    <button id="shop-btn" class="small-btn" onclick="openShop()">ğŸ›’ ìƒì </button>
                    <button id="reset-btn" class="small-btn" onclick="resetData()">ğŸ”„ ì´ˆê¸°í™”</button>
                </div>
            </div>
            
            <div class="popup-modal" id="shop-ui">
                <div class="popup-inner">
                    <div class="popup-title">HELICOPTER SHOP</div>
                    <div class="shop-grid" id="skin-list"></div>
                    <button class="btn-close" onclick="closeShop()">ë‹«ê¸°</button>
                </div>
            </div>

            <div class="popup-modal" id="tutorial-ui">
                <div class="popup-inner">
                    <div class="tab-header">
                        <button class="tab-btn active" onclick="switchTab(0)">ê²Œì„ ë°©ë²•</button>
                        <button class="tab-btn" onclick="switchTab(1)">ê³„ê¸‰ ë„ê°</button>
                        <button class="tab-btn" onclick="switchTab(2)">ìƒì¡´ íŒ</button>
                    </div>
                    <div class="tab-body">
                        <div class="tab-pane active" id="tab-0">
                            <p><span class="guide-icon">ğŸš€</span> ë°°íŒ… ê¸ˆì•¡ì„ ì„ íƒí•˜ê³  <b>[START]</b> í•˜ì„¸ìš”.</p>
                            <p><span class="guide-icon">ğŸ“ˆ</span> í—¬ê¸°ê°€ ìƒìŠ¹í•˜ë©´ ëˆì´ ë¶ˆì–´ë‚©ë‹ˆë‹¤. (ì¡´ë²„)</p>
                            <p><span class="guide-icon">ğŸ’°</span> ì¶”ë½í•˜ê¸° ì „ì— í™”ë©´ì„ <b>í„°ì¹˜</b>í•˜ì—¬ íƒˆì¶œí•˜ì„¸ìš”!</p>
                            <p class="warn-text">âš ï¸ ìš•ì‹¬ë¶€ë¦¬ë‹¤ ì¶”ë½í•˜ë©´ 0ì›ì´ ë©ë‹ˆë‹¤.</p>
                        </div>
                        <div class="tab-pane" id="tab-1">
                            <p>ğŸ® <b>í‘ìš°:</b> ~ 5ë§Œ G (ì‹œì‘)</p>
                            <p>ğŸ‘¶ <b>ì½”ë¦°ì´:</b> ~ 20ë§Œ G</p>
                            <p>ğŸ¦ <b>ì•¼ìˆ˜:</b> ~ 50ë§Œ G</p>
                            <p>ğŸ‹ <b>ì„¸ë ¥:</b> ~ 100ë§Œ G</p>
                            <p>ğŸ“ <b>ì¡¸ì—…ìƒ:</b> 100ë§Œ G ì´ìƒ (ì „ì„¤)</p>
                        </div>
                        <div class="tab-pane" id="tab-2">
                            <p>ğŸš¨ <b>ë¶‰ì€ ê²½ê³ :</b> ì—”ì§„ ê³¼ì—´! ì¶”ë½ ìœ„í—˜ì´ í½ë‹ˆë‹¤.</p>
                            <p>ğŸ“‰ <b>í•˜ë½ì¥(ì¡°ì •):</b> ê°€ì§œ ì¶”ë½ ì‹œ <span class="warn-text">ëˆì´ ì¤„ì–´ë“­ë‹ˆë‹¤!</span> í•˜ì§€ë§Œ ë²„í‹°ë©´...</p>
                            <p>ğŸ“ˆ <b>ë°˜ë“±:</b> í•˜ë½ì¥ì„ ê²¬ë””ë©´ 60% í™•ë¥ ë¡œ <b>ê¸‰ë“±</b>í•©ë‹ˆë‹¤.</p>
                            <p>âœ¨ <b>í™©ê¸ˆ í™”ë©´:</b> í”¼ë²„ íƒ€ì„! ìˆ˜ìµì´ 2ë°°~4ë°° í­ë°œí•©ë‹ˆë‹¤.</p>
                        </div>
                    </div>
                    <button class="btn-close" onclick="closeTutorial()">ë‹«ê¸°</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let audioCtx = null;
        function initAudio() { if (!audioCtx) { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } if (audioCtx.state === 'suspended') { audioCtx.resume(); } }
        const Sound = {
            playTone: (freq, type, duration, vol = 0.1) => { if (!audioCtx) return; const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime); gain.gain.setValueAtTime(vol, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration); osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + duration); },
            playNoise: (duration) => { if (!audioCtx) return; const bufferSize = audioCtx.sampleRate * duration; const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate); const data = buffer.getChannelData(0); for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1; const noise = audioCtx.createBufferSource(); noise.buffer = buffer; const gain = audioCtx.createGain(); gain.gain.setValueAtTime(0.2, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration); noise.connect(gain); gain.connect(audioCtx.destination); noise.start(); },
            playClick: () => Sound.playTone(800, 'square', 0.1, 0.05),
            playStart: () => { Sound.playTone(400, 'sine', 0.1); setTimeout(()=>Sound.playTone(600, 'sine', 0.2), 100); },
            playCash: () => { Sound.playTone(1200, 'sine', 0.1); setTimeout(()=>Sound.playTone(1800, 'sine', 0.3), 50); },
            playCrash: () => { Sound.playNoise(0.5); Sound.playTone(100, 'sawtooth', 0.5, 0.2); }
        };
        let engineOsc = null; let engineGain = null;
        function startEngineSound() { if (!audioCtx) return; if (engineOsc) stopEngineSound(); engineOsc = audioCtx.createOscillator(); engineGain = audioCtx.createGain(); engineOsc.type = 'sawtooth'; engineOsc.frequency.value = 50; engineGain.gain.value = 0.05; engineOsc.connect(engineGain); engineGain.connect(audioCtx.destination); engineOsc.start(); }
        function updateEnginePitch(speed) { if(engineOsc && audioCtx) { const targetFreq = 50 + (speed / 10); engineOsc.frequency.setTargetAtTime(targetFreq, audioCtx.currentTime, 0.1); } }
        function stopEngineSound() { if(engineOsc && audioCtx) { engineGain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.5); engineOsc.stop(audioCtx.currentTime + 0.5); engineOsc = null; } }

        const CONFIG = { baseGoldRate: 0.2, maxSpeed: 1200, startMoney: 5000 }; 
        let currentBet = 1000; let betMultiplier = 1; 

        const SKINS = [ { id: 'default', name: 'ê¸°ë³¸ ë ˆë“œ', price: 0, color: '#e74c3c' }, { id: 'military', name: 'ë°€ë¦¬í„°ë¦¬', price: 50000, color: '#556B2F', class: 'skin-military' }, { id: 'marine', name: 'ë§ˆë¦° ë¸”ë£¨', price: 100000, color: '#00BFFF', class: 'skin-marine' }, { id: 'gold', name: 'í™©ê¸ˆ í—¬ê¸°', price: 500000, color: '#FFD700', class: 'skin-gold' } ];
        const RANKS = [ { limit: 50000, name: "í‘ìš°", id: "BEGGAR", color: "#aaa", icon: "ğŸ®" }, { limit: 200000, name: "ì½”ë¦°ì´", id: "NEWBIE", color: "#4CAF50", icon: "ğŸ‘¶" }, { limit: 500000, name: "ì•¼ìˆ˜", id: "BEAST", color: "#03A9F4", icon: "ğŸ¦" }, { limit: 1000000, name: "ì„¸ë ¥", id: "WHALE", color: "#E91E63", icon: "ğŸ‹" }, { limit: Infinity, name: "ì¡¸ì—…", id: "LEGEND", color: "#FFD700", icon: "ğŸ“" } ];
        const CHAT_LOGS = { start: ["ê°€ì¦ˆì•„!", "ì´ë²ˆì—” 10ë§Œ ê°„ë‹¤", "íƒ‘ìŠ¹ ì™„ë£Œ", "ì˜ì°¨ì˜ì°¨", "ã„±ã„±ã„±", "í˜• ë¯¿ëŠ”ë‹¤", "í’€ë§¤ìˆ˜ ë•Œë¦¼"], fever: ["ë²„í…¨!!", "ì•„ì§ ì•„ëƒ", "ë”í™©ì± !!", "ì™€ ë¯¸ì³¤ë‹¤", "í™”ì„± ê°ˆë„ë‹ˆê¹Œ~", "íŒ¬í‹° ë²—ê³  ì†Œë¦¬ì§ˆëŸ¬!"], warning: ["ì—°ê¸° ë­ì•¼?", "ì§­ì´ë„¤ ã…‹", "ã…Œã…Œã…Œ", "ì–´ì–´ ì ë§ˆ ì™œì €ëŸ¬ë…¸", "íƒˆì¶œê°?", "êµ¬ì¡°ëŒ€ ì–¸ì œ ì˜´?"], crash: ["í•œê°•ë¬¼ ë”°ëœ»í•˜ëƒ", "ì•„ ë‚´ ëˆ...", "ì£¼ì‘ê²œ ë§í•´ë¼", "ã…‹ã…‹ã…‹ã…‹ã…‹", "ë‚˜ë§Œ ì•„ë‹ˆë©´ ë¼~", "ì§€ì˜¥ ê°€ë„¤"], escape: ["êº¼ì–µ~", "ì¹˜í‚¨ê°’ ë²Œì—ˆë‹¤", "ìˆ˜ê³ ë§", "ìµì ˆí•©ë‹ˆë‹¤ ^^", "ì•ˆì „ì œì¼", "ë‚´ê°€ íŒ”ë©´ ì˜¤ë¥´ë”ë¼"] };
        const NEWS_TITLES = [ "ì†ë³´: ì¼ë¡  ë¨¸ìŠ¤í¬, ë„ì§€ì½”ì¸ìœ¼ë¡œ í™”ì„± ì—¬í–‰ ê²°ì œ í—ˆìš©", "ì†ë³´: ë¹„íŠ¸ì½”ì¸ 1ì–µ ëŒíŒŒ! ì „ ì„¸ê³„ê°€ ì£¼ëª©", "ë‹¨ë…: ì˜†ì§‘ ì² ìˆ˜, ì ê¸ˆ ê¹¨ê³  ì¡´ë²„ì½¥í„° íƒ‘ìŠ¹", "ì†ë³´: ì—°ì¤€, ê¸ˆë¦¬ ì¸í•˜ ë°œí‘œ... ê°€ìƒí™”í ì‹œì¥ í™˜í˜¸", "ì£¼ì˜: ê±°ë˜ì†Œ ì„œë²„ ë¶ˆì•ˆì •... íˆ¬ììë“¤ 'ë°œë™ë™'", "ë‚ ì”¨: í•œê°• ìˆ˜ì˜¨ ì²´í¬ ì¤‘... ìˆ˜ì˜ ê¸ˆì§€", "ì†ë³´: ì •ë¶€, ê°€ìƒí™”í ê³¼ì„¸ ìœ ì˜ˆ ê²€í†  ì¤‘", "ì†ë³´: ì•ŒíŠ¸ì½”ì¸ ëŒ€í­ë½! ë¹„ëª… ì§€ë¥´ëŠ” ê°œë¯¸ë“¤", "í™”ì œ: 100ë°° ìˆ˜ìµ ì¸ì¦ìƒ· ì»¤ë®¤ë‹ˆí‹° ë„ë°°", "ê²½ê³ : 'ê¹€ì¹˜ í”„ë¦¬ë¯¸ì—„' ì—­ëŒ€ ìµœê³ ì¹˜ ê²½ì‹ ", "ì†Œë¬¸: ì›Œë Œ ë²„í•, ëª°ë˜ ë¹„íŠ¸ì½”ì¸ ë§¤ì§‘ ì¤‘?", "ë‹¨ë…: ì¡´ë²„ì½¥í„°, ë‚˜ìŠ¤ë‹¥ ìƒì¥ ì¶”ì§„ ë£¨ë¨¸", "ì†ë³´: ìœ ëª… ìœ íŠœë²„ 'ì¡´ë²„ë§¨', 100ì–µ ìµì ˆ ì¸ì¦", "í™”ì œ: ìƒì–´ë²„ë¦° ë¹„íŠ¸ì½”ì¸ ì§€ê°‘ ë¹„ë²ˆ ì°¾ì•˜ë‹¤!" ];

        let state = { status: 'ready', ms: 0, currentRunGold: 0, speed: 0, crashTime: 0, isFever: false, feverTime: 0, feverRate: 2, nextRateChange: 0, events: [], airPocketY: 0, isSysError: false, bgLevel: 0, canReset: false, isDipping: false };
        let myWallet = { money: CONFIG.startMoney, rank: 'BEGGAR', ownedSkins: ['default'], equippedSkin: 'default', name: '' };
        let history = []; let participants = []; let lastTimestamp = 0;

        const ui = { 
            frame: document.getElementById('game-frame'), heli: document.getElementById('heli'), heliBody: document.getElementById('heli-body'), 
            dynamic: document.getElementById('dynamic-layer'), score: document.getElementById('score-box'), timer: document.getElementById('timer-box'), 
            msg: document.getElementById('status-msg'), center: document.getElementById('center-ui'), btn: document.getElementById('start-btn'), 
            lb: document.getElementById('lb-content'), fever: document.getElementById('fever-filter'), danger: document.getElementById('danger-effect'), 
            warning: document.getElementById('warning-box'), myMoney: document.getElementById('my-money-display'), myRankBadge: document.getElementById('my-rank-badge'),
            chat: document.getElementById('chat-box'), shop: document.getElementById('shop-ui'), skinList: document.getElementById('skin-list'), 
            historyBox: document.getElementById('history-box'), nameInput: document.getElementById('nickname-input'), 
            stars1: document.getElementById('stars1'), stars2: document.getElementById('stars2'), stars3: document.getElementById('stars3'), marsFog: document.getElementById('marsFog'), 
            newsTicker: document.getElementById('news-ticker'), newsContent: document.getElementById('news-content'), tutorial: document.getElementById('tutorial-ui')
        };
        const root = document.documentElement;

        window.onload = () => { loadData(); applySkin(); updateHistoryUI(); startNewsTicker(); };
        function loadData() { const saved = localStorage.getItem('heliTycoonDataV68'); if (saved) { try { const data = JSON.parse(saved); if(data.wallet) myWallet = data.wallet; if(data.history) history = data.history; } catch(e) {} } if(myWallet.name) ui.nameInput.value = myWallet.name; updateRank(); updateWalletUI(); }
        function saveData() { localStorage.setItem('heliTycoonDataV68', JSON.stringify({ wallet: myWallet, history: history })); updateWalletUI(); }
        function resetData() { if(!confirm("ì´ˆê¸°í™” í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return; localStorage.removeItem('heliTycoonDataV68'); myWallet = { money: CONFIG.startMoney, rank: 'BEGGAR', ownedSkins: ['default'], equippedSkin: 'default', name: '' }; history = []; ui.nameInput.value = ''; applySkin(); saveData(); updateHistoryUI(); alert("ì´ˆê¸°í™” ì™„ë£Œ!"); }
        function updateRank() { const m = myWallet.money; const r = RANKS.find(rk => m < rk.limit) || RANKS[RANKS.length-1]; myWallet.rank = r.id; }
        function updateWalletUI() { ui.myMoney.innerText = Math.floor(myWallet.money).toLocaleString() + " G"; const r = RANKS.find(rk => rk.id === myWallet.rank); ui.myRankBadge.innerText = r.icon + " " + r.name; ui.myRankBadge.style.background = r.color; }
        function updateHistoryUI() { ui.historyBox.innerHTML = ''; history.forEach(res => { const dot = document.createElement('div'); let colorClass = 'h-blue'; if (res.time < 2) colorClass = 'h-blue'; else if (res.time < 10) colorClass = 'h-green'; else if (res.time < 25) colorClass = 'h-red'; else colorClass = 'h-gold'; dot.className = `history-dot ${colorClass}`; ui.historyBox.appendChild(dot); }); }
        function startNewsTicker() { ui.newsTicker.style.display = 'block'; pickNews(); ui.newsContent.addEventListener('animationiteration', pickNews); }
        function pickNews() { const news = NEWS_TITLES[Math.floor(Math.random() * NEWS_TITLES.length)]; ui.newsContent.innerText = news; }
        
        function setBet(amount, mult, btnElement) { 
            initAudio(); Sound.playClick(); 
            currentBet = amount; betMultiplier = mult; 
            const buttons = document.querySelectorAll('.bet-btn'); buttons.forEach(b => b.classList.remove('active')); if(btnElement) btnElement.classList.add('active'); 
        }
        
        function openShop() { initAudio(); Sound.playClick(); ui.shop.style.display = 'flex'; renderShop(); }
        function closeShop() { initAudio(); Sound.playClick(); ui.shop.style.display = 'none'; }
        function renderShop() { ui.skinList.innerHTML = ''; SKINS.forEach(skin => { const div = document.createElement('div'); const isOwned = myWallet.ownedSkins.includes(skin.id); const isEquipped = myWallet.equippedSkin === skin.id; div.className = `skin-card ${isOwned ? 'owned' : ''} ${isEquipped ? 'equipped' : ''}`; div.innerHTML = `<div style="font-size:1.5vh; font-weight:bold; font-family:'Noto Sans KR'">${skin.name}</div><div class="skin-preview" style="background:${skin.color}; border-radius:0.5vh;"></div><div class="skin-price">${skin.price === 0 ? 'ë¬´ë£Œ' : (skin.price/10000) + 'ë§Œ G'}</div><button class="skin-btn ${isOwned ? 'btn-equip' : 'btn-buy'}">${isEquipped ? 'ì¥ì°© ì¤‘' : (isOwned ? 'ì¥ì°©í•˜ê¸°' : 'êµ¬ë§¤í•˜ê¸°')}</button>`; div.onclick = (e) => { e.stopPropagation(); handleSkinAction(skin); }; ui.skinList.appendChild(div); }); }
        function handleSkinAction(skin) { const isOwned = myWallet.ownedSkins.includes(skin.id); if (isOwned) { initAudio(); Sound.playClick(); myWallet.equippedSkin = skin.id; applySkin(); renderShop(); saveData(); } else { if (myWallet.money >= skin.price) { if(confirm(`${skin.name}ì„(ë¥¼) êµ¬ë§¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) { initAudio(); Sound.playCash(); myWallet.money -= skin.price; myWallet.ownedSkins.push(skin.id); myWallet.equippedSkin = skin.id; applySkin(); renderShop(); saveData(); } } else alert("ì”ì•¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤!"); } }
        function applySkin() { const skinId = myWallet.equippedSkin; const skinData = SKINS.find(s => s.id === skinId); ui.heliBody.className = 'pixel-heli'; if(skinData.class) ui.heliBody.classList.add(skinData.class); }
        function addChat(name, msg) { const div = document.createElement('div'); div.className = 'chat-msg'; div.innerHTML = `<span class="chat-name">${name}:</span> ${msg}`; ui.chat.prepend(div); if(ui.chat.children.length > 5) ui.chat.lastChild.remove(); }
        function randomChat(type) { if(Math.random() > 0.6) return; const list = CHAT_LOGS[type]; const msg = list[Math.floor(Math.random() * list.length)]; const botName = participants.length > 0 ? participants[Math.floor(Math.random()*(participants.length-1))+1].name : "ìµëª…"; addChat(botName, msg); }

        function openTutorial() { initAudio(); Sound.playClick(); ui.tutorial.style.display = 'flex'; switchTab(0); }
        function closeTutorial() { initAudio(); Sound.playClick(); ui.tutorial.style.display = 'none'; }
        function switchTab(index) {
            const tabs = document.querySelectorAll('.tab-btn');
            const panes = document.querySelectorAll('.tab-pane');
            tabs.forEach((t, i) => { if(i === index) t.classList.add('active'); else t.classList.remove('active'); });
            panes.forEach((p, i) => { if(i === index) p.classList.add('active'); else p.classList.remove('active'); });
        }

        ui.frame.addEventListener('touchstart', (e) => { e.preventDefault(); handleAction(); }, {passive: false});
        
        const allBtns = document.querySelectorAll('button, input');
        allBtns.forEach(btn => {
            btn.addEventListener('touchstart', (e) => { e.stopPropagation(); }, {passive: false});
            btn.addEventListener('click', (e) => { e.stopPropagation(); });
        });

        ui.btn.addEventListener('click', (e) => { e.stopPropagation(); handleAction(); });
        document.addEventListener('keydown', (e) => { if (e.code === 'Space') { e.preventDefault(); handleAction(); } });
        
        function handleAction() { 
            if (state.status === 'ready') startGame(); 
            else if (state.status === 'playing') playerEscape(); 
            else if ((state.status === 'crashed' || state.status === 'escaped') && state.canReset) resetGame(); 
        }

        function startGame() {
            initAudio(); if (myWallet.money < currentBet) { alert("ì°¸ê°€ë¹„ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!"); return; }
            const inputName = ui.nameInput.value.trim(); if(inputName) myWallet.name = inputName;
            Sound.playStart(); startEngineSound();
            myWallet.money -= currentBet; saveData();
            state.status = 'playing'; state.ms = 0; state.currentRunGold = 0; state.speed = 100; 
            state.isFever = false; state.isSysError = false; state.airPocketY = 0; state.bgLevel = 0;
            state.crashTime = Math.random() * 25000 + 5000; state.feverTime = Math.random() * 10000 + 5000; state.nextRateChange = state.feverTime + 2000; state.events = [];
            state.canReset = false; state.isDipping = false;
            ui.frame.style.backgroundPosition = "center bottom"; ui.stars1.style.opacity = 0; ui.stars2.style.opacity = 0; ui.stars3.style.opacity = 0; ui.marsFog.style.opacity = 0; 
            
            let numFakes = Math.floor(Math.random() * 3); for(let i=0; i<numFakes; i++) state.events.push({ type: 'fake', time: Math.random() * (state.crashTime - 2000) + 2000 });
            if(Math.random() < 0.6) state.events.push({ type: 'airpocket', time: Math.random() * (state.crashTime - 5000) + 3000 });
            if(Math.random() < 0.7) state.events.push({ type: 'syserror', time: Math.random() * (state.crashTime - 5000) + 2000 });
            
            setupParticipants();
            ui.center.style.display = 'none'; ui.warning.style.display = 'none'; ui.msg.innerText = "í„°ì¹˜í•˜ì—¬ ìµì ˆí•˜ì„¸ìš”!"; ui.heli.style.top = "50%"; ui.heli.className = "heli-wrapper"; ui.heliBody.classList.remove('heli-rumble', 'rotor-stop'); ui.fever.style.display = 'none'; ui.danger.style.display = 'none'; ui.chat.innerHTML = '';
            const playerName = myWallet.name || "íŒŒì¼ëŸ¿"; addChat("SYSTEM", `${playerName}ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤!`); randomChat('start');
            lastTimestamp = performance.now(); requestAnimationFrame(gameLoop);
        }

        function gameLoop(timestamp) {
            if (state.status !== 'playing' && state.status !== 'escaped') return;
            const deltaTime = timestamp - lastTimestamp; lastTimestamp = timestamp; state.ms += deltaTime;
            if (state.speed < CONFIG.maxSpeed) state.speed += (deltaTime * 0.05);
            updateEnginePitch(state.speed); root.style.setProperty('--speed-factor', 1 + (state.speed / 300));
            const flightSec = state.ms / 1000; let bgPos = Math.min(100, (flightSec / 30) * 100); ui.frame.style.backgroundPosition = `center ${100 - bgPos}%`;
            if (flightSec > 3) { ui.stars1.style.opacity = 1; ui.stars2.style.opacity = 1; } if (flightSec > 20) { ui.marsFog.style.opacity = 0.6; }
            let rate = CONFIG.baseGoldRate * betMultiplier; 
            if (state.ms >= state.feverTime) { if (!state.isFever) { state.isFever = true; ui.fever.style.display = 'block'; ui.heliBody.classList.add('heli-rumble'); randomChat('fever'); Sound.playTone(600, 'square', 0.5); } if (state.ms >= state.nextRateChange) { state.feverRate = Math.floor(Math.random() * 3) + 2; state.nextRateChange = state.ms + (Math.random() * 1000 + 500); } ui.msg.innerText = `í”¼ë²„ íƒ€ì„! ìˆ˜ìµ x${state.feverRate}`; ui.msg.style.color = "#ff3333"; rate = rate * state.feverRate; }
            
            if (state.isDipping) {
                let dropRate = 0.1; 
                if(betMultiplier === 2) dropRate = 0.2;
                if(betMultiplier === 5) dropRate = 0.35; 
                let loss = (state.currentRunGold * dropRate * (deltaTime/1000));
                
                // [ìˆ˜ì •] ë´‡ë„ ë˜‘ê°™ì´ ëˆì„ ìƒë„ë¡ ìˆ˜ì • (isBot ì²´í¬ ì œê±°)
                participants.forEach(p => { 
                    if(p.status === 'playing') {
                        p.gold -= loss; 
                        if(p.gold < 0) p.gold = 0;
                    }
                });
                ui.score.classList.add('score-panic');
                ui.msg.innerText = "ì¡°ì •ì¥ ì§„ì…! ë²„í‹°ì„¸ìš”!";
            } else {
                let earnedNow = Math.floor(deltaTime * rate);
                participants.forEach(p => { if (p.status === 'playing') { p.gold += earnedNow; if (p.isBot && state.ms >= p.targetTime) { p.status = 'escaped'; spawnBotVisual(false); if(Math.random()<0.3) addChat(p.name, CHAT_LOGS['escape'][Math.floor(Math.random()*CHAT_LOGS['escape'].length)]); } } });
                ui.score.classList.remove('score-panic');
            }

            const myPlayer = participants.find(p => !p.isBot); if (state.status === 'playing') { 
                if(myPlayer.gold < 0) myPlayer.gold = 0;
                state.currentRunGold = Math.floor(myPlayer.gold); 
            }
            state.events.forEach((ev) => { if (state.ms >= ev.time && !ev.triggered) { ev.triggered = true; triggerEvent(ev.type); } });
            if (state.ms >= state.crashTime) { crashGame(); return; }
            if (state.isSysError) { ui.score.innerText = "### G"; ui.timer.innerText = "ì˜¤ë¥˜"; } else { ui.score.innerText = state.currentRunGold.toLocaleString() + " G"; ui.timer.innerText = (state.ms / 1000).toFixed(2) + "s"; }
            let shake = Math.sin(timestamp / 100) * 5; ui.heli.style.transform = `translate(-50%, calc(-50% + ${shake}px + ${state.airPocketY}vh))`;
            updateLeaderboard(); requestAnimationFrame(gameLoop);
        }

        function triggerEvent(type) { 
            if (type === 'fake') { 
                spawnWarningEffect(); showHudWarning(); 
                ui.msg.innerText = "í•˜ë½ì¥ ì‹œì‘!"; randomChat('warning'); 
                Sound.playTone(300, 'sawtooth', 0.3);
                triggerAirPocket(2); 
                state.isDipping = true;
                setTimeout(() => { 
                    state.isDipping = false; 
                    if (!state.isFever && Math.random() < 0.6) {
                        ui.msg.innerText = "ì €ì  ë§¤ìˆ˜! ë°˜ë“± ì„±ê³µ!";
                        ui.msg.style.color = "#4caf50";
                        state.speed += 300; 
                    } else {
                        ui.msg.innerText = "ë°˜ë“± ì‹¤íŒ¨... íš¡ë³´ ì¤‘";
                    }
                }, 1500); 
            } 
            else if (type === 'syserror') { state.isSysError = true; ui.msg.innerText = "ì‹œìŠ¤í…œ ì˜¤ë¥˜ ë°œìƒ..."; setTimeout(() => { state.isSysError = false; ui.msg.innerText = "ì‹œìŠ¤í…œ ë³µêµ¬ë¨"; }, 2000); } 
            else if (type === 'airpocket') { ui.msg.innerText = "ë‚œê¸°ë¥˜ ë°œìƒ!"; triggerAirPocket(5); } 
        }
        
        function triggerAirPocket(depth) {
            let drop = setInterval(() => { state.airPocketY += 0.5; if (state.airPocketY >= depth) { clearInterval(drop); setTimeout(() => { let rec = setInterval(() => { state.airPocketY -= 0.2; if(state.airPocketY <= 0) { state.airPocketY = 0; clearInterval(rec); } }, 20); }, 100); } }, 10);
        }

        function showHudWarning() { ui.warning.style.display = 'block'; ui.danger.style.display = 'block'; setTimeout(() => { ui.warning.style.display = 'none'; ui.danger.style.display = 'none'; }, 1500); }

        function playerEscape() { stopEngineSound(); Sound.playCash(); state.status = 'escaped'; const myPlayer = participants.find(p => !p.isBot); myPlayer.status = 'escaped'; let sorted = [...participants].sort((a,b) => b.gold - a.gold); let myRankIndex = sorted.findIndex(p => !p.isBot); let bonusPercent = 0; if(myRankIndex === 0) bonusPercent = 0.3; else if(myRankIndex === 1) bonusPercent = 0.2; else if(myRankIndex === 2) bonusPercent = 0.1; let bonusAmount = Math.floor(state.currentRunGold * bonusPercent); let totalEarned = currentBet + state.currentRunGold + bonusAmount; myWallet.money += totalEarned; updateRank(); saveData(); spawnBotVisual(true); ui.btn.innerText = "ë‹¤ì‹œ ì‹œì‘"; ui.center.style.display = 'none'; state.canReset = false; let resultText = "ê´€ì „ ì¤‘... (ê²°ê³¼ ëŒ€ê¸°)"; if (bonusPercent > 0) resultText = `ê´€ì „ ì¤‘... (ë³´ë„ˆìŠ¤ í™•ë³´!)`; ui.msg.innerText = resultText; ui.msg.style.color = "#4CAF50"; randomChat('escape'); }
        function crashGame() { stopEngineSound(); Sound.playCrash(); state.status = 'crashed'; ui.fever.style.display = 'none'; ui.danger.style.display = 'block'; ui.warning.style.display = 'none'; ui.heliBody.classList.remove('heli-rumble'); state.isSysError = false; ui.heli.classList.add('crashed-anim'); const myPlayer = participants.find(p => !p.isBot); if (myPlayer.status === 'playing') { myPlayer.status = 'crashed'; myPlayer.gold = 0; } participants.forEach(p => { if (p.status === 'playing') { p.status = 'crashed'; p.gold = 0; } }); const crashSec = state.ms / 1000; history.push({ time: crashSec }); if(history.length > 10) history.shift(); saveData(); updateHistoryUI(); updateLeaderboard(); randomChat('crash'); setTimeout(() => { ui.center.style.display = 'flex'; ui.danger.style.display = 'none'; state.canReset = true; if (myPlayer.status === 'escaped') { ui.center.querySelector('h2').innerText = "ì¡´ë²„ ì„±ê³µ!"; ui.center.querySelector('h2').style.color = "#4CAF50"; ui.score.style.color = "#4CAF50"; ui.btn.innerText = "ë‹¤ìŒ ë¼ìš´ë“œ"; ui.msg.innerText = "ìˆ˜ìµ í™•ë³´ ì™„ë£Œ"; } else { ui.score.innerText = "CRASHED"; ui.score.style.color = "#ff3333"; ui.center.querySelector('h2').innerText = "ì¡´ë²„ ì‹¤íŒ¨..."; ui.center.querySelector('h2').style.color = "#ff3333"; ui.btn.innerText = "ì¬ì‹œë„"; if(myWallet.money < 1000) ui.msg.innerText = "íŒŒì‚° ìœ„ê¸°! ì´ˆê¸°í™” ê¶Œì¥"; else ui.msg.innerText = `-${currentBet.toLocaleString()} G ì†ì‹¤...`; } }, 2000); }
        function setupParticipants() { const playerName = myWallet.name || "ë‚˜ (YOU)"; participants = [{ name: playerName, isBot: false, status: 'playing', gold: 0, targetTime: null }]; const botNames = ['ìµì ˆì¥ì¸', 'í—¬ë¦°ì´', 'ê°€ì¦ˆì•„', 'í•œê°•ë·°', 'êµ¬ì¡°ëŒ€', 'ì¡´ë²„ë§¨', 'ë‹¨íƒ€ì™•', 'í’€ë§¤ìˆ˜', 'ë–¡ìƒê¸°ì›']; botNames.forEach(n => { let target = Math.random() * 30000 + 2000; participants.push({ name: n, isBot: true, status: 'playing', gold: 0, targetTime: target }); }); }
        
        // [FIX] ë¦¬ë”ë³´ë“œ: Math.floor()ë¡œ ì†Œìˆ˜ì  ì œê±°
        function updateLeaderboard() { 
            if (state.isSysError) { ui.lb.innerHTML = ""; return; } 
            let sorted = [...participants].sort((a, b) => b.gold - a.gold); 
            ui.lb.innerHTML = ""; 
            sorted.forEach((p, idx) => { 
                let div = document.createElement('div'); div.className = 'lb-row'; 
                let stClass = ''; let stIcon = 'ğŸš'; let bonusTag = ""; 
                if(p.status !== 'crashed') { 
                    if(idx === 0) bonusTag = `<span class="bonus-tag bonus-1">+30%</span>`; 
                    else if(idx === 1) bonusTag = `<span class="bonus-tag bonus-2">+20%</span>`; 
                    else if(idx === 2) bonusTag = `<span class="bonus-tag bonus-3">+10%</span>`; 
                } 
                if (p.status === 'escaped') { stClass = 'lb-escaped'; stIcon = 'âœ…'; } 
                else if (p.status === 'crashed') { stClass = 'lb-dead'; stIcon = 'ğŸ’€'; } 
                if (!p.isBot) stClass += ' lb-me'; 
                div.innerHTML = `<span class="${stClass}">${idx+1}. ${p.name}${bonusTag}</span><span>${stIcon} ${Math.floor(p.gold).toLocaleString()}</span>`; 
                ui.lb.appendChild(div); 
            }); 
        }
        
        function spawnWarningEffect() { for(let i=0; i<3; i++) { let s = document.createElement('div'); s.className = 'smoke'; s.style.left = (42 + Math.random()*2) + "%"; s.style.top = (50 + Math.random()*2) + "%"; ui.dynamic.appendChild(s); setTimeout(() => s.remove(), 800); } for(let i=0; i<5; i++) { let sp = document.createElement('div'); sp.className = 'spark'; sp.style.left = "50%"; sp.style.top = "50%"; sp.style.setProperty('--tx', (Math.random()*100 - 50) + 'px'); sp.style.setProperty('--ty', (Math.random()*100 - 50) + 'px'); ui.dynamic.appendChild(sp); setTimeout(() => sp.remove(), 500); } }
        function spawnBotVisual(isPlayer) { let b = document.createElement('div'); b.className = 'bot'; let p = document.createElement('div'); p.className = 'parachute'; b.appendChild(p); if (isPlayer) b.classList.add('player-chute'); ui.dynamic.appendChild(b); setTimeout(() => b.remove(), 3000); }
        function resetGame() { state.status = 'ready'; ui.btn.innerText = "ê²Œì„ ì‹œì‘"; ui.center.querySelector('h2').innerText = "ì¡´ë²„ì½¥í„°"; ui.center.querySelector('h2').style.color = "white"; ui.score.innerText = "0 G"; ui.score.style.color = "#ffd700"; ui.timer.innerText = "00.00s"; ui.heli.style.transform = "translate(-50%, -50%) rotate(0deg)"; ui.msg.innerText = "í„°ì¹˜í•˜ì—¬ íƒˆì¶œ"; ui.msg.style.color = "#ccc"; ui.warning.style.display = 'none'; ui.danger.style.display = 'none'; ui.chat.innerHTML=''; ui.frame.style.backgroundPosition = "center bottom"; ui.stars1.style.opacity = 0; ui.stars2.style.opacity = 0; ui.stars3.style.opacity = 0; ui.marsFog.style.opacity = 0; state.airPocketY = 0; }
    </script>
</body>
</html>
